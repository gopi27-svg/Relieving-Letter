<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Relieving Letter Bulk Tool</title>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: system-ui; margin: 24px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f4f6fb; }
    .btn { background:#2257d6;color:#fff;padding:10px 16px;border:none;border-radius:8px;cursor:pointer }
    .err { background:#ffe5e5 }
  </style>
</head>
<body>

<h2>ðŸ“§ Relieving Letter Bulk Tool</h2>

<button class="btn" onclick="downloadSample()">â¬‡ Download Sample Excel</button>
<br><br>

<input type="file" id="file" accept=".xlsx" />
<div id="preview"></div>

<br>
<button class="btn" onclick="sendToAPI()">ðŸ“¨ Send Mails</button>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxsqOdcW-cn0ftSrzV98IvPINjGhyktR2mRVWf0hqDDorArGtKTZS3c5W5V-AGp4FSo/exec';

let rows = [];

function downloadSample() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([
    ['Employee Name','Designation','Date of Joining','Date of Exit','Email']
  ]);
  XLSX.utils.book_append_sheet(wb, ws, 'Sample');
  XLSX.writeFile(wb, 'Relieving_Letter_Sample.xlsx');
}

document.getElementById('file').addEventListener('change', e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type:'binary' });
    rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    renderPreview();
  };
  reader.readAsBinaryString(e.target.files[0]);
});

function renderPreview() {
  let html = '<table><tr>';
  Object.keys(rows[0]).forEach(h => html += `<th>${h}</th>`);
  html += '</tr>';

  rows.forEach(r => {
    const bad = !r['Employee Name'] || !r['Designation'] || !r['Date of Exit'] || !r['Email'];
    html += `<tr class="${bad?'err':''}">`;
    Object.values(r).forEach(v => html += `<td>${v||''}</td>`);
    html += '</tr>';
  });
  html += '</table>';
  document.getElementById('preview').innerHTML = html;
}

function sendToAPI() {
  fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ rows })
  })
  .then(r => r.json())
  .then(res => alert(res.message))
  .catch(err => alert('Error: ' + err));
}
</script>

</body>
</html>
